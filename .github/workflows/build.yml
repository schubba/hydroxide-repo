name: Hydroxide Build & Push
on:
  schedule:
    - cron: '0 2 * * *' # Läuft jede Nacht um 02:00 Uhr
  workflow_dispatch: # Erlaubt Ihnen, den Build jederzeit manuell zu starten

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.21'

      - name: Install Hydroxide & Tools
        run: |
          go install github.com/emersion/hydroxide/cmd/hydroxide@latest
          sudo apt-get update
          sudo apt-get install -y ruby-dev build-essential rpm
          sudo gem install fpm

      - name: Create Packages
        run: |
          # 1. Version festlegen
          VERSION=$(~/go/bin/hydroxide -v 2>&1 | awk '{print $2}' | sed 's/v//' || echo "0.1.0")
          
          # 2. Die exakte Zielstruktur lokal nachbauen
          # Wir erstellen den Pfad, in dem die Datei später auf dem Zielsystem liegen soll
          mkdir -p usr/local/bin
          cp ~/go/bin/hydroxide usr/local/bin/
          
          # 3. DEB Paket bauen
          # Wir sagen fpm: Nimm alles ab dem aktuellen Verzeichnis (.)
          # fpm erkennt automatisch die usr/local/bin Struktur
          fpm -s dir -t deb -n hydroxide -v $VERSION usr
          
          # 4. RPM Paket bauen
          fpm -s dir -t rpm -n hydroxide -v $VERSION usr


      - name: Push to Cloudsmith
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
        run: |
          pip install cloudsmith-cli
          cloudsmith push deb opensource-89f5/hydroxide/any-distro/any-version *.deb
          cloudsmith push rpm opensource-89f5/hydroxide/any-distro/any-version *.rpm
